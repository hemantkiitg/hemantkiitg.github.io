---
layout: single
title: "In-Browser Chat (WebLLM)"
permalink: /ai/webllm/
author_profile: true
---

<h2>In-Browser AI Chat</h2>
<p>This runs fully in your browser. First load downloads model files. Use Chrome/Edge desktop for WebGPU.</p>

<div style="margin:12px 0;">
  <label for="model">Model:</label>
  <select id="model">
    <option>Qwen2.5-3B-Instruct-q4f16_1-MLC</option>
    <option>Llama-3-8B-Instruct-q4f16_1-MLC</option>
  </select>
  <span id="status" style="margin-left:8px;"></span>
</div>

<div id="chat" style="border:1px solid #e5e5e5;border-radius:12px;padding:12px;min-height:240px;max-height:520px;overflow:auto;"></div>

<div style="display:flex;gap:8px;margin-top:8px;">
  <textarea id="prompt" rows="3" style="flex:1;" placeholder="Ask something…"></textarea>
  <button id="send" disabled>Send</button>
</div>

<script type="module">
  import { CreateWebWorkerMLCEngine } from "https://esm.run/@mlc-ai/web-llm";

  const chat = document.getElementById('chat');
  const input = document.getElementById('prompt');
  const send = document.getElementById('send');
  const status = document.getElementById('status');
  const modelSel = document.getElementById('model');

  if (!('gpu' in navigator)) {
    status.textContent = " WebGPU not supported (use Chrome/Edge desktop).";
  }

  let engine = null;
  let messages = [{ role: "system", content: "You are a concise, helpful assistant." }];

  async function loadModel() {
    send.disabled = true;
    chat.innerHTML = "";
    status.textContent = " Loading model…";
    try {
      engine = await CreateWebWorkerMLCEngine(modelSel.value, {
        initProgressCallback: (p) => {
          status.textContent = " Loading: " + Math.round(100 * p.progress) + "%";
        }
      });
      status.textContent = " Ready.";
      send.disabled = false;
      input.focus();
    } catch (e) {
      status.textContent = " Load error: " + e.message;
      console.error(e);
    }
  }

  modelSel.addEventListener('change', loadModel);
  await loadModel(); // top-level await requires type="module"

  function bubble(text, who) {
    const d = document.createElement('div');
    d.style.whiteSpace = 'pre-wrap';
    d.style.margin = '8px 0';
    d.style.padding = '8px 10px';
    d.style.borderRadius = '10px';
    d.style.background = who === 'user' ? '#f6f8fa' : '#fff';
    d.textContent = text;
    chat.appendChild(d);
    chat.scrollTop = chat.scrollHeight;
    return d;
  }

  async function ask() {
    const q = input.value.trim();
    if (!q || !engine) return;
    input.value = '';
    bubble(q, 'user');
    const ans = bubble('…', 'bot');
    send.disabled = true;
    try {
      messages.push({ role: "user", content: q });
      const stream = await engine.chat.completions.create({ messages, stream: true });
      ans.textContent = "";
      for await (const ch of stream) {
        ans.textContent += ch?.choices?.[0]?.delta?.content ?? "";
        chat.scrollTop = chat.scrollHeight;
      }
      messages.push({ role: "assistant", content: ans.textContent });
    } catch (e) {
      ans.textContent = "Error: " + e.message;
      console.error(e);
    } finally {
      send.disabled = false;
    }
  }

  send.addEventListener('click', ask);
  input.addEventListener('keydown', e => {
    if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); ask(); }
  });
</script>
