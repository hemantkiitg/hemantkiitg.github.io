---
layout: single
title: "In-Browser Chat (WebLLM)"
permalink: /ai/webllm/
author_profile: true
---

<h2>In-Browser AI Chat</h2>
<p>This runs fully in your browser via WebGPU. First load downloads model files.</p>

<div style="margin:12px 0;">
  <label for="model">Model:</label>
  <select id="model">
    <option>Qwen2.5-3B-Instruct-q4f16_1-MLC</option>
    <option>Llama-3-8B-Instruct-q4f16_1-MLC</option>
  </select>
  <span id="status" style="margin-left:8px;"></span>
</div>

<div id="chat" style="border:1px solid #e5e5e5;border-radius:12px;padding:12px;min-height:260px;max-height:520px;overflow:auto;"></div>

<div style="display:flex;gap:8px;margin-top:8px;">
  <textarea id="prompt" rows="3" style="flex:1;" placeholder="Ask something…"></textarea>
  <button id="send">Send</button>
</div>

<script type="module">
  import { CreateWebWorkerMLCEngine } from "https://esm.run/@mlc-ai/web-llm";

  const chat = document.getElementById('chat');
  const promptEl = document.getElementById('prompt');
  const sendBtn = document.getElementById('send');
  const status = document.getElementById('status');
  const modelSel = document.getElementById('model');

  if (!('gpu' in navigator)) {
    status.textContent = " WebGPU not supported (try Chrome/Edge desktop).";
    sendBtn.disabled = true;
  }

  let engine = null;
  let messages = [{ role: "system", content: "You are a concise, helpful assistant." }];

  async function loadModel() {
    sendBtn.disabled = true;
    chat.innerHTML = "";
    status.textContent = " Loading…";
    engine = await CreateWebWorkerMLCEngine(modelSel.value, {
      initProgressCallback: (p) => {
        status.textContent = " Loading: " + Math.round(100 * p.progress) + "%";
      }
    });
    status.textContent = " Ready.";
    sendBtn.disabled = false;
    promptEl.focus();
  }

  modelSel.addEventListener('change', loadModel);
  await loadModel();

  function addBubble(text, who) {
    const div = document.createElement('div');
    div.style.padding = '8px 10px';
    div.style.margin = '8px 0';
    div.style.borderRadius = '10px';
    div.style.whiteSpace = 'pre-wrap';
    if (who === 'user') { div.style.background = '#f6f8fa'; }
    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
    div.textContent = text;
    return div;
  }

  sendBtn.addEventListener('click', async () => {
    const q = promptEl.value.trim();
    if (!q || !engine) return;
    promptEl.value = '';
    const userDiv = addBubble(q, 'user');

    messages.push({ role: "user", content: q });
    const aDiv = addBubble("…", 'assistant');

    sendBtn.disabled = true;
    try {
      const stream = await engine.chat.completions.create({
        messages,
        stream: true,
      });
      aDiv.textContent = "";
      for await (const chunk of stream) {
        const delta = chunk?.choices?.[0]?.delta?.content || "";
        aDiv.textContent += delta;
        chat.scrollTop = chat.scrollHeight;
      }
      messages.push({ role: "assistant", content: aDiv.textContent });
    } catch (e) {
      aDiv.textContent = "Error: " + e.message;
    } finally {
      sendBtn.disabled = false;
    }
  });

  // Enter = send (Shift+Enter for newline)
  promptEl.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendBtn.click(); }
  });
</script>
